/**
 * Angular provider for integration with WebAPI2 token authentication
 * @version v0.0.6 - 2014-04-16
 * @link 
 * @author Kenneth Lynne <kenneth.lynne@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */angular.module("kennethlynne.webAPI2Authentication",[]).provider("webAPIAuth",function(e){var t="",n="",r="",i="token",s="",o="",u="";e.interceptors.push(["$q","$injector",function(e,t){return{request:function(r){var i=t.get("webAPIAuth").getToken();var s=r.url.substr(0,n.length)===n;if(i&&s){r.headers["Authorization"]="Bearer "+i}return r||e.when(r)}}}]);this.setLocalstorageKey=function(e){i=e};this.setTokenEndpointUrl=function(e){t=e};this.setLogoutEndpointUrl=function(e){r=e};this.setExternalUserInfoEndpointUrl=function(e){s=e};this.setRegisterExternalUserEndpointUrl=function(e){o=e};this.setDeleteAccountEndpointUrl=function(e){u=e};this.setAPIUrl=function(e){n=e};this.$get=["$http","$window","$q",function(e,n,a){var f=n.localStorage,l=function(){var t=a.defer(),n={method:"POST",url:r,headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:"Bearer "+c()}};e(n).then(function(e){if(e&&e.data){t.resolve(true)}else{t.reject("No data received")}}).catch(function(e){var n=e&&e.data&&e.data.message?e.data.message:"";t.reject("Could not log you out. "+n)});f.removeItem(i);return t.promise},c=function(){return f.getItem(i)},h=function(e){return f.setItem(i,e)},p=function(n,r,i){var s=a.defer(),o={method:"POST",url:t,data:"grant_type="+n+"&username="+r+"&password="+i,headers:{"Content-Type":"application/x-www-form-urlencoded"}};e(o).then(function(e){if(e&&e.data){h(e.data.access_token);s.resolve(true)}else{s.reject("No data received")}}).catch(function(e){var t=e&&e.data&&e.data.message?e.data.message:"";s.reject("Could not log you in. "+t)});return s.promise},d=function(){return typeof c()=="string"},v=function(t){var n=a.defer(),r={method:"GET",url:s,headers:{Authorization:"Bearer "+t}};e(r).then(function(e){if(e&&e.data){n.resolve(e.data)}else{n.reject("No data received")}}).catch(function(e){var t=e&&e.data&&e.data.message?e.data.message:"";n.reject("Could not get external user info. "+t)});return n.promise},m=function(t,n){var r=a.defer();cfg={method:"POST",url:o,data:"userName="+n,headers:{Authorization:"Bearer "+t,"Content-Type":"application/x-www-form-urlencoded"}};e(cfg).then(function(e){r.resolve(e.data)}).catch(function(e){var t=e&&e.data&&e.data.message?e.data.message:"";r.reject("Could not register external user. "+t)}).finally(function(){$log.log("Register external user request finished.")});return r.promise},g=function(t){var n=a.defer();var r={method:"POST",url:u,headers:{Authorization:"Bearer "+t,"Content-Type":"application/x-www-form-urlencoded"}};e(r).then(function(e){n.resolve(e.data)}).catch(function(e){var t=e&&e.data&&e.data.message?e.data.message:"";n.reject("Could not delete account. "+t)}).finally(function(){$log.log("Delete account request finished.")});return n.promise};return{isLoggedIn:d,login:p,getExternalUserInfo:v,registerExternalUser:m,getToken:c,setToken:h,logout:l,deleteAccount:g}}]})